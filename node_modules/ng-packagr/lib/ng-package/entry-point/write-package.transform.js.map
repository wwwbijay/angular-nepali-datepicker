{"version":3,"file":"write-package.transform.js","sourceRoot":"","sources":["../../../../src/lib/ng-package/entry-point/write-package.transform.ts"],"names":[],"mappings":"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","sourcesContent":["import ora from 'ora';\nimport * as path from 'path';\nimport { BuildGraph } from '../../graph/build-graph';\nimport { Node } from '../../graph/node';\nimport { transformFromPromise } from '../../graph/transform';\nimport { colors } from '../../utils/color';\nimport { copyFile, rmdir, stat, writeFile } from '../../utils/fs';\nimport { globFiles } from '../../utils/glob';\nimport * as log from '../../utils/log';\nimport { ensureUnixPath } from '../../utils/path';\nimport { EntryPointNode, PackageNode, fileUrl, isEntryPoint, isEntryPointInProgress, isPackage } from '../nodes';\nimport { NgPackagrOptions } from '../options.di';\nimport { NgPackage } from '../package';\nimport { NgEntryPoint } from './entry-point';\n\ntype CompilationMode = 'partial' | 'full' | undefined;\n\nexport const writePackageTransform = (options: NgPackagrOptions) =>\n  transformFromPromise(async graph => {\n    const spinner = ora({\n      hideCursor: false,\n      discardStdin: false,\n    });\n    const entryPoint: EntryPointNode = graph.find(isEntryPointInProgress());\n    const ngEntryPoint: NgEntryPoint = entryPoint.data.entryPoint;\n    const ngPackageNode: PackageNode = graph.find(isPackage);\n    const ngPackage = ngPackageNode.data;\n    const { destinationFiles } = entryPoint.data;\n    const ignorePaths: string[] = [\n      '.gitkeep',\n      '**/.DS_Store',\n      '**/Thumbs.db',\n      '**/node_modules/**',\n      `${ngPackage.dest}/**`,\n    ];\n\n    if (!ngEntryPoint.isSecondaryEntryPoint) {\n      const assetFiles: string[] = [];\n\n      // COPY ASSET FILES TO DESTINATION\n      spinner.start('Copying assets');\n\n      try {\n        for (const asset of [...ngPackage.assets, 'LICENSE', '**/README.md']) {\n          let assetFullPath = path.join(ngPackage.src, asset);\n\n          try {\n            const stats = await stat(assetFullPath);\n            if (stats.isFile()) {\n              assetFiles.push(assetFullPath);\n              continue;\n            }\n\n            if (stats.isDirectory()) {\n              assetFullPath = path.join(assetFullPath, '**/*');\n            }\n          } catch {}\n\n          if (asset === 'LICENSE') {\n            continue;\n          }\n\n          const files = await globFiles(assetFullPath, {\n            ignore: ignorePaths,\n            cache: ngPackageNode.cache.globCache,\n            dot: true,\n            nodir: true,\n          });\n\n          if (files.length) {\n            assetFiles.push(...files);\n          }\n        }\n\n        for (const file of assetFiles) {\n          const relativePath = path.relative(ngPackage.src, file);\n          const destination = path.resolve(ngPackage.dest, relativePath);\n          const nodeUri = fileUrl(ensureUnixPath(file));\n          let node = graph.get(nodeUri);\n          if (!node) {\n            node = new Node(nodeUri);\n            graph.put(node);\n          }\n\n          entryPoint.dependsOn(node);\n          await copyFile(file, destination);\n        }\n      } catch (error) {\n        spinner.fail();\n        throw error;\n      }\n      spinner.succeed();\n    }\n\n    // 6. WRITE PACKAGE.JSON\n    try {\n      spinner.start('Writing package manifest');\n      const relativeUnixFromDestPath = (filePath: string) =>\n        ensureUnixPath(path.relative(ngEntryPoint.destinationPath, filePath));\n\n      const { compilationMode } = entryPoint.data.tsConfig.options;\n\n      await writePackageJson(\n        ngEntryPoint,\n        ngPackage,\n        {\n          module: relativeUnixFromDestPath(destinationFiles.fesm2015),\n          es2020: relativeUnixFromDestPath(destinationFiles.fesm2020),\n          esm2020: relativeUnixFromDestPath(destinationFiles.esm2020),\n          fesm2020: relativeUnixFromDestPath(destinationFiles.fesm2020),\n          fesm2015: relativeUnixFromDestPath(destinationFiles.fesm2015),\n          typings: relativeUnixFromDestPath(destinationFiles.declarations),\n          exports: ngEntryPoint.isSecondaryEntryPoint ? undefined : generatePackageExports(ngEntryPoint, graph),\n          // webpack v4+ specific flag to enable advanced optimizations and code splitting\n          sideEffects: ngEntryPoint.packageJson.sideEffects ?? false,\n        },\n        !!options.watch,\n        compilationMode as CompilationMode,\n        spinner,\n      );\n    } catch (error) {\n      spinner.fail();\n      throw error;\n    }\n    spinner.succeed();\n    spinner.succeed(`Built ${ngEntryPoint.moduleId}`);\n\n    return graph;\n  });\n\n/**\n * Creates and writes a `package.json` file of the entry point used by the `node_module`\n * resolution strategies.\n *\n * #### Example\n *\n * A consumer of the entry point depends on it by `import {..} from '@my/module/id';`.\n * The module id `@my/module/id` will be resolved to the `package.json` file that is written by\n * this build step.\n * The properties `main`, `module`, `typings` (and so on) in the `package.json` point to the\n * flattened JavaScript bundles, type definitions, (...).\n *\n * @param entryPoint An entry point of an Angular package / library\n * @param additionalProperties Additional properties, e.g. binary artefacts (bundle files), to merge into `package.json`\n */\nasync function writePackageJson(\n  entryPoint: NgEntryPoint,\n  pkg: NgPackage,\n  additionalProperties: { [key: string]: string | boolean | string[] | ConditionalExport },\n  isWatchMode: boolean,\n  compilationMode: CompilationMode,\n  spinner: ora.Ora,\n): Promise<void> {\n  log.debug('Writing package.json');\n\n  // set additional properties\n  const packageJson = { ...entryPoint.packageJson, ...additionalProperties };\n\n  // read tslib version from `@angular/compiler` so that our tslib\n  // version at least matches that of angular if we use require('tslib').version\n  // it will get what installed and not the minimum version nor if it is a `~` or `^`\n  // this is only required for primary\n  if (!entryPoint.isSecondaryEntryPoint) {\n    if (isWatchMode) {\n      // Needed because of Webpack's 5 `cachemanagedpaths`\n      // https://github.com/angular/angular-cli/issues/20962\n      packageJson.version = `0.0.0-watch+${Date.now()}`;\n    }\n\n    if (!packageJson.peerDependencies?.tslib && !packageJson.dependencies?.tslib) {\n      const {\n        peerDependencies: angularPeerDependencies = {},\n        dependencies: angularDependencies = {},\n      } = require('@angular/compiler/package.json');\n      const tsLibVersion = angularPeerDependencies.tslib || angularDependencies.tslib;\n\n      if (tsLibVersion) {\n        packageJson.dependencies = {\n          ...packageJson.dependencies,\n          tslib: tsLibVersion,\n        };\n      }\n    } else if (packageJson.peerDependencies?.tslib) {\n      spinner.warn(\n        colors.yellow(\n          `'tslib' is no longer recommended to be used as a 'peerDependencies'. Moving it to 'dependencies'.`,\n        ),\n      );\n      packageJson.dependencies = {\n        ...(packageJson.dependencies || {}),\n        tslib: packageJson.peerDependencies.tslib,\n      };\n\n      delete packageJson.peerDependencies.tslib;\n    }\n  }\n\n  // Verify non-peerDependencies as they can easily lead to duplicate installs or version conflicts\n  // in the node_modules folder of an application\n  const allowedList = pkg.allowedNonPeerDependencies.map(value => new RegExp(value));\n  try {\n    checkNonPeerDependencies(packageJson, 'dependencies', allowedList, spinner);\n  } catch (e) {\n    await rmdir(entryPoint.destinationPath, { recursive: true });\n    throw e;\n  }\n\n  // Removes scripts from package.json after build\n  if (packageJson.scripts) {\n    if (pkg.keepLifecycleScripts !== true) {\n      spinner.info(`Removing scripts section in package.json as it's considered a potential security vulnerability.`);\n      delete packageJson.scripts;\n    } else {\n      spinner.warn(\n        colors.yellow(\n          `You enabled keepLifecycleScripts explicitly. The scripts section in package.json will be published to npm.`,\n        ),\n      );\n    }\n  }\n\n  if (!entryPoint.isSecondaryEntryPoint && compilationMode !== 'partial') {\n    const scripts = packageJson.scripts || (packageJson.scripts = {});\n    scripts.prepublishOnly =\n      'node --eval \"console.error(\\'' +\n      'ERROR: Trying to publish a package that has been compiled by Ivy in full compilation mode. This is not allowed.\\\\n' +\n      'Please delete and rebuild the package with Ivy partial compilation mode, before attempting to publish.\\\\n' +\n      '\\')\" ' +\n      '&& exit 1';\n  }\n\n  // keep the dist package.json clean\n  // this will not throw if ngPackage field does not exist\n  delete packageJson.ngPackage;\n\n  const packageJsonPropertiesToDelete = [\n    'stylelint',\n    'prettier',\n    'browserslist',\n    'devDependencies',\n    'jest',\n    'workspaces',\n    'husky',\n  ];\n\n  for (const prop of packageJsonPropertiesToDelete) {\n    if (prop in packageJson) {\n      delete packageJson[prop];\n      spinner.info(`Removing ${prop} section in package.json.`);\n    }\n  }\n\n  packageJson.name = entryPoint.moduleId;\n  await writeFile(path.join(entryPoint.destinationPath, 'package.json'), JSON.stringify(packageJson, undefined, 2));\n}\n\nfunction checkNonPeerDependencies(\n  packageJson: Record<string, unknown>,\n  property: string,\n  allowed: RegExp[],\n  spinner: ora.Ora,\n) {\n  if (!packageJson[property]) {\n    return;\n  }\n\n  for (const dep of Object.keys(packageJson[property])) {\n    if (allowed.some(regex => regex.test(dep))) {\n      log.debug(`Dependency ${dep} is allowed in '${property}'`);\n    } else {\n      spinner.warn(\n        colors.yellow(\n          `Distributing npm packages with '${property}' is not recommended. Please consider adding ${dep}` +\n            `to 'peerDependencies' or remove it from '${property}'.`,\n        ),\n      );\n      throw new Error(`Dependency ${dep} must be explicitly allowed using the \"allowedNonPeerDependencies\" option.`);\n    }\n  }\n}\n\ntype PackageExports = Record<string, ConditionalExport>;\n\n/**\n * Type describing the conditional exports descriptor for an entry-point.\n * https://nodejs.org/api/packages.html#packages_conditional_exports\n */\ntype ConditionalExport = {\n  node?: string;\n  types?: string;\n  esm2020?: string;\n  es2020?: string;\n  es2015?: string;\n  default?: string;\n};\n\n/**\n * Generates the `package.json` package exports following APF v13.\n * This is supposed to match with: https://github.com/angular/angular/blob/e0667efa6eada64d1fb8b143840689090fc82e52/packages/bazel/src/ng_package/packager.ts#L415.\n */\nfunction generatePackageExports({ destinationPath, packageJson }: NgEntryPoint, graph: BuildGraph): PackageExports {\n  const exports: PackageExports = packageJson.exports ? JSON.parse(JSON.stringify(packageJson.exports)) : {};\n\n  const insertMappingOrError = (subpath: string, mapping: ConditionalExport) => {\n    if (exports[subpath] === undefined) {\n      exports[subpath] = {};\n    }\n\n    const subpathExport = exports[subpath];\n\n    // Go through all conditions that should be inserted. If the condition is already\n    // manually set of the subpath export, we throw an error. In general, we allow for\n    // additional conditions to be set. These will always precede the generated ones.\n    for (const conditionName of Object.keys(mapping) as [keyof ConditionalExport]) {\n      if (subpathExport[conditionName] !== undefined) {\n        throw Error(\n          `Found a conflicting export condition for \"${subpath}\". The \"${conditionName}\" ` +\n            `condition would be overridden by ng-packagr. Please unset it.`,\n        );\n      }\n\n      // **Note**: The order of the conditions is preserved even though we are setting\n      // the conditions once at a time (the latest assignment will be at the end).\n      subpathExport[conditionName] = mapping[conditionName];\n    }\n  };\n\n  const relativeUnixFromDestPath = (filePath: string) =>\n    './' + ensureUnixPath(path.relative(destinationPath, filePath));\n\n  insertMappingOrError('./package.json', { default: './package.json' });\n\n  const entryPoints = graph.filter(isEntryPoint);\n  for (const entryPoint of entryPoints) {\n    const { destinationFiles, isSecondaryEntryPoint } = entryPoint.data.entryPoint;\n    const subpath = isSecondaryEntryPoint ? `./${destinationFiles.directory}` : '.';\n\n    insertMappingOrError(subpath, {\n      types: relativeUnixFromDestPath(destinationFiles.declarations),\n      esm2020: relativeUnixFromDestPath(destinationFiles.esm2020),\n      es2020: relativeUnixFromDestPath(destinationFiles.fesm2020),\n      es2015: relativeUnixFromDestPath(destinationFiles.fesm2015),\n      node: relativeUnixFromDestPath(destinationFiles.fesm2015),\n      default: relativeUnixFromDestPath(destinationFiles.fesm2020),\n    });\n  }\n\n  return exports;\n}\n"]}
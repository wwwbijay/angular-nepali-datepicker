{"version":3,"file":"rollup.js","sourceRoot":"","sources":["../../../src/lib/flatten/rollup.ts"],"names":[],"mappings":"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","sourcesContent":["import rollupJson from '@rollup/plugin-json';\nimport nodeResolve from '@rollup/plugin-node-resolve';\nimport * as path from 'path';\nimport * as rollup from 'rollup';\nimport { TransformHook } from 'rollup';\nimport sourcemaps from 'rollup-plugin-sourcemaps';\nimport { OutputFileCache } from '../ng-package/nodes';\nimport { readCacheEntry, saveCacheEntry } from '../utils/cache';\nimport * as log from '../utils/log';\nimport { ensureUnixPath } from '../utils/path';\n\n/**\n * Options used in `ng-packagr` for writing flat bundle files.\n *\n * These options are passed through to rollup.\n */\nexport interface RollupOptions {\n  moduleName: string;\n  entry: string;\n  dest: string;\n  sourceRoot: string;\n  transform?: TransformHook;\n  cache?: rollup.RollupCache;\n  cacheDirectory?: string | false;\n  fileCache: OutputFileCache;\n  cacheKey: string;\n}\n\n/** Runs rollup over the given entry file, writes a bundle file. */\nexport async function rollupBundleFile(\n  opts: RollupOptions,\n): Promise<{ cache: rollup.RollupCache; code: string; map: rollup.SourceMap }> {\n  log.debug(`rollup (v${rollup.VERSION}) ${opts.entry} to ${opts.dest}`);\n\n  const cacheDirectory = opts.cacheDirectory;\n\n  // Create the bundle\n  const bundle = await rollup.rollup({\n    context: 'this',\n    external: moduleId => isExternalDependency(moduleId),\n    inlineDynamicImports: false,\n    cache: opts.cache ?? (cacheDirectory ? await readCacheEntry(cacheDirectory, opts.cacheKey) : undefined),\n    input: opts.entry,\n    plugins: [\n      nodeResolve(),\n      sourcemaps({\n        readFile: (path: string, callback: (error: Error | null, data: Buffer | string) => void) => {\n          const fileData = opts.fileCache.get(ensureUnixPath(path));\n          callback(fileData ? null : new Error(`Could not load '${path}' from memory.`), fileData?.content);\n        },\n      }),\n      rollupJson(),\n      opts.transform ? { transform: opts.transform, name: 'downlevel-ts' } : undefined,\n    ],\n    onwarn: warning => {\n      switch (warning.code) {\n        case 'UNUSED_EXTERNAL_IMPORT':\n        case 'THIS_IS_UNDEFINED':\n          break;\n\n        default:\n          log.warn(warning.message);\n          break;\n      }\n    },\n    preserveSymlinks: true,\n    // Disable treeshaking when generating bundles\n    // see: https://github.com/angular/angular/pull/32069\n    treeshake: false,\n  });\n\n  // Output the bundle to disk\n  const output = await bundle.write({\n    name: opts.moduleName,\n    format: 'es',\n    file: opts.dest,\n    banner: '',\n    sourcemap: true,\n  });\n\n  if (cacheDirectory) {\n    await saveCacheEntry(cacheDirectory, opts.cacheKey, JSON.stringify(bundle.cache));\n  }\n\n  const { code, map } = output.output[0];\n\n  // Close the bundle to let plugins clean up their external processes or services\n  await bundle.close();\n\n  return {\n    code: code + '//# sourceMapping' + `URL=${path.basename(opts.dest)}.map\\n`,\n    map,\n    cache: bundle.cache,\n  };\n}\n\nfunction isExternalDependency(moduleId: string): boolean {\n  // more information about why we don't check for 'node_modules' path\n  // https://github.com/rollup/rollup-plugin-node-resolve/issues/110#issuecomment-350353632\n  if (moduleId.startsWith('.') || moduleId.startsWith('/') || path.isAbsolute(moduleId)) {\n    // if it's either 'absolute', marked to embed, starts with a '.' or '/' or is the umd bundle and is tslib\n    return false;\n  }\n\n  return true;\n}\n"]}